# Title decisions are possible vs _all_ titles and are shown in the Title Diplomacy View, not the Intrigue View. The taker is in the FROM scope.
#
# filter = [capital/primary_title/owned/vassal_owned/sub_realm_owned/realm_owned/dynasty_owned/all]
# ai_target_filter = [capital/primary_title/owned/vassal_owned/sub_realm_owned/realm_owned/dynasty_owned/all] (which titles for which the AI evaluates the decision.)
#	owned: all titles owned by the AI
#	vassal_owned: all titles owned by direct vassal rulers of the AI's employer
#	sub_realm_owned: all titles below the AI's employer
#	realm_owned: all titles in the same top realm as the AI
#	dynasty_owned: all titles owned by members of the same dynasty
#	all: all titles (Avoid if possible. VERY CPU-HEAVY!)
#	

title_decisions = {
	abandon_province = {
		only_playable = yes
		filter = sub_realm_owned
		ai_target_filter = sub_realm_owned
		
		from_potential = {
			is_nomadic = yes
			has_dlc = "Horse Lords"
		}
		
		potential = {
			tier = COUNT
			location = {
				owner = {
					same_realm = FROM
				}
				any_neighbor_province = {
					owner = {
						NOT = { same_realm = FROM }
					}
				}
			}
		}

		allow = {
			location = {
				NOT = { num_of_settlements = 1 }
			}
			has_siege = no
			FROM = {
				war = no
			}
			location = {
				NOT = { has_province_modifier = nomads_exploited_land }
			}
		}
		effect = {
			holder_scope = {
				capital_holding = {
					add_holding_modifier = {
						modifier = nomad_population_boom
						years = 8
						stacking = yes
					}
				}
				hidden_tooltip = {
					top_liege = {
						if = { 
							limit = { NOT = { character = PREV } } 
							capital_holding = {
								add_holding_modifier = {
									modifier = nomad_population_boom_spillover
									years = 8
									stacking = yes
								}
							}
						}
						any_vassal = {
							limit = {
								NOT = { character = PREVPREV }
								clan = yes
							}
							capital_holding = {
								add_holding_modifier = {
									modifier = nomad_population_boom_spillover
									years = 8
									stacking = yes
								}
							}
						}
					}
				}
			}
			location = {
				random_neighbor_province = {
					limit = {
						owner = {
							NOT = {
								same_realm = FROM
							}
						}
					}
					owner = {
						ROOT = {
							grant_title = PREV
						}
					}
				}
			}
			location = {
				add_province_modifier = {
					modifier = nomads_exploited_land
					years = 8
				}
			}
		}
		revoke_allowed = {
			always = no
		}
		ai_will_do = {
			factor = 0
		}
	}
	
	set_crown_focus = { # High Prio version
		only_playable = yes
		filter = owned
		ai_target_filter = owned
		is_high_prio = yes
		
		from_potential = {
			is_playable = yes
			has_dlc = "Reapers"
			is_nomadic = no
			higher_tier_than = COUNT
			NOT = {
				any_demesne_province = {
					has_province_flag = crown_focus_province
				}
			}
		}
		
		potential = {
			owner = { character = FROM }
			tier = count
		}

		allow = {
			hidden_tooltip = {
				OR = {
					FROM = {
						ai = no
					}
					FROM = {
						NOT = {
							any_demesne_province = {
								has_province_flag = crown_focus_province
							}
						}
					}
				}
			}

			location = {
				capital_holding = {
					NOR = {
						has_siege = yes
						is_occupied = yes 
					}
				}
			}
			
			FROM = {	
				OR = {
					AND = {
						independent = yes
						higher_tier_than = COUNT
					}
					AND = {
						independent = no
						tier = DUKE
						realm_size = 35
					}
					AND = {
						independent = no
						tier = KING
						realm_size = 55
					}
					AND = {
						independent = no
						OR = {
							is_merchant_republic = yes
							is_republic = yes
						}
					}
				}
			}
		}

		effect = {
			FROM = {
				any_demesne_province = {
					limit = {
						has_province_flag = crown_focus_province
					}
					clr_province_flag = crown_focus_province
				}
			}
			location = { set_province_flag = crown_focus_province }
		}

		revoke_allowed = {
			always = no
		}

		ai_will_do = {
			factor = 1
		}
	}
	
	move_crown_focus = {
		only_playable = yes
		filter = owned
		ai_target_filter = owned
		
		from_potential = {
			is_playable = yes
			has_dlc = "Reapers"
			is_nomadic = no
			higher_tier_than = COUNT
			any_demesne_province = {
				has_province_flag = crown_focus_province
			}
		}
		
		potential = {
			owner = { character = FROM }
			tier = count
			NOT = { location = { has_province_flag = crown_focus_province } }
		}

		allow = {
			hidden_tooltip = {
				OR = {
					FROM = {
						ai = no
					}
					FROM = {
						NOT = {
							any_demesne_province = {
								has_province_flag = crown_focus_province
							}
						}
					}
				}
			}

			location = {
				capital_holding = {
					NOR = {
						has_siege = yes
						is_occupied = yes 
					}
				}
			}
			
			FROM = {
				OR = {
					AND = {
						independent = yes
						higher_tier_than = COUNT
					}
					AND = {
						independent = no
						tier = DUKE
						realm_size = 35
					}
					AND = {
						independent = no
						tier = KING
						realm_size = 55
					}
					AND = {
						independent = no
						OR = {
							is_merchant_republic = yes
							is_republic = yes
						}
					}
				}
			}
		}

		effect = {
			FROM = {
				any_demesne_province = {
					limit = {
						has_province_flag = crown_focus_province
					}
					clr_province_flag = crown_focus_province
				}
			}
			location = { set_province_flag = crown_focus_province }
		}

		revoke_allowed = {
			always = no
		}

		ai_will_do = {
			factor = 1
		}
	}

	## Create new Vassal
	TOW_title_create_new_vassal = {
		only_rulers = yes
		ai_target_filter = owned
		filter = owned
		
		from_potential = {
			is_playable = yes
			higher_real_tier_than = COUNT
		}

		potential = {
			tier = COUNT
			owner = { character = FROM }
		}

		allow = {
			location = {
				capital_holding = {
					OR = {
						holding_type = castle
						holding_type = city
						holding_type = temple
						holding_type = tribal
					}
				}
			}
			custom_tooltip = {
				text = TOOLTIP_TOW_province_not_capital
				hidden_tooltip = {
					FROM = {
						capital_scope = {
					    	county = {
					    		NOT = { title = ROOT }
					    	}
					  	}
					}
				}
			}
			#is_occupied = no
			#NOT = {
			#	any_province_holding = {
			#		has_siege = yes
			#	}
			#}
		}

		effect = {
			FROM = {
				save_event_target_as = employer
				hidden_tooltip = {
					primary_title = {
						FROM = {
							TOW_create_random_courtier_gender_equality = yes
							TOW_employed_remove_unwanted_traits_with_ET_employer = yes
							new_character = {
								TOW_remove_bad_traits = yes
								grant_title = ROOT
							}
						}
					}
				}
			}
		}

		ai_will_do = {
			factor = 0
		}
	}
	
	## Grant title to smallest clan
	TOW_title_grant_title_to_smallest_clan = {
		only_rulers = yes
		ai_target_filter = owned
		filter = owned
		
		from_potential = {
			is_playable = yes
			is_nomadic = yes
			tier = emperor
		}

		potential = {
			tier = COUNT
			owner = { character = FROM }
		}

		allow = {
			custom_tooltip = {
				text = province_not_capital_tooltip
				hidden_tooltip = {
					FROM = {
						capital_scope = {
							county = {
					    		NOT = { title = ROOT }
					    	}
					  	}
					}
				}
			}
			FROM = {
				any_vassal = {
					is_nomadic = yes
					tier = king
					clan_title = { always = yes }
				}
			}
		}

		effect = {
			hidden_tooltip = {
				FROM = {
					set_variable = { which = global_TOW_smallest_clan_land_count value = -1 }
					set_variable = { which = global_TOW_smallest_clan_std_land_count value = -1 }
					any_vassal = {
						limit = {
							is_nomadic = yes
							tier = king
							clan_title = { always = yes }
						}
						set_variable = { which = TOW_clan_standard_land_count value = 0 }
						set_variable = { which = TOW_clan_nomadic_land_count value = 0 }
						any_demesne_title = {
							limit = {
								tier = count
								location = { TOW_is_county_nomadic = yes }
							}
							PREV = { change_variable = { which = TOW_clan_nomadic_land_count value = 1 } }
						}
						any_demesne_title = {
							limit = {
								tier = count
								location = { NOT = { TOW_is_county_nomadic = yes } }
							}
							PREV = { change_variable = { which = TOW_clan_standard_land_count value = 1 } }
						}

						
						if = {
							limit = {
								OR = {
									is_variable_equal = { which = global_TOW_smallest_clan_land_count value = -1 }
									NOT = { check_variable = { which = TOW_clan_nomadic_land_count which = global_TOW_smallest_clan_land_count } }
									AND = {
										is_variable_equal = { which = TOW_clan_nomadic_land_count which = global_TOW_smallest_clan_land_count }
										NOT = { check_variable = { which = TOW_clan_standard_land_count which = global_TOW_smallest_clan_std_land_count } }
									}
								}
							}
							set_variable = { which = global_TOW_smallest_clan_land_count which = TOW_clan_nomadic_land_count }
							set_variable = { which = global_TOW_smallest_clan_std_land_count which = TOW_clan_standard_land_count }
							save_event_target_as = smallest_clan_holder
						}
						
					}
				}
			}
			event_target:smallest_clan_holder = {
				grant_title = ROOT
			}
		}

		ai_will_do = {
			factor = 0
		}
	}

	TOW_title_pillage_all_settlements = {
		only_rulers = yes
		ai_target_filter = owned
		filter = owned
		
		from_potential = {
			is_playable = yes
			OR = {
				is_nomadic = yes
				AND = {
					is_tribal = yes
					independent = yes
				}
			}
			has_dlc = "Horse Lords"
		}

		potential = {
			tier = COUNT
			owner = { character = FROM }

			location = {
				any_province_holding = {
					TOW_holding_can_be_pillaged_by_from = yes
				}
			}
		}

		allow = {
			location = {
				any_province_holding = {
					TOW_holding_can_be_pillaged_by_from_tooltip = yes

					TOW_holding_can_be_pillaged_allow = yes
				}
			}
		}

		effect = {
			location = {
				any_province_holding = {
					limit = {
						TOW_holding_can_be_pillaged_by_from_tooltip = yes
					
						TOW_holding_can_be_pillaged_allow = yes
					}

					FROM = { save_event_target_as = pillager }
					TOW_pillage_holding = yes
				}
			}
		}

		ai_will_do = {
			factor = 0
		}
	}

	TOW_title_stop_pillage_all_settlements = {
		only_rulers = yes
		ai_target_filter = owned
		filter = owned
		
		from_potential = {
			is_playable = yes
			OR = {
				is_nomadic = yes
				AND = {
					is_tribal = yes
					independent = yes
				}
			}
			has_dlc = "Horse Lords"
		}

		potential = {
			tier = COUNT
			owner = { character = FROM }
			location = {
				any_province_holding = {
					TOW_holding_can_stop_pillage_by_from = yes
				}
			}
		}

		allow = {
			location = {
				any_province_holding = {
					TOW_holding_can_stop_pillage_by_from_allow = yes
				}
			}
		}

		effect = {
			location = {
				any_province_holding = {
					limit = {
						TOW_holding_can_stop_pillage_by_from = yes
					}

					custom_tooltip = {
						text = TOOLTIP_TOW_stop_pillaging
						hidden_tooltip = {
							add_holding_modifier = {
								modifier = stop_burning_land
								hidden = yes
								years = 1
							}
						}
					}
				}
			}
		}

		ai_will_do = {
			factor = 0
		}
	}
}