# 
nomad_dispute = {
	name = CB_NAME_DISPUTE
	war_name = CB_NAME_DISPUTE
	sprite = 16
	truce_days = 1095
	hostile_against_others = yes
	is_permanent = yes
	check_all_titles = yes
	can_ask_to_join_war = no
	
	allow_distant = yes

	allowed_to_target_tributaries = no
	
	sort_priority = 700

	can_use = {
		FROM = {
			TOW_is_creep_realm = yes
		}
		ROOT = {
			TOW_is_creep_realm = yes
			same_realm = FROM
			has_feud_with = FROM
		}
		
		ROOT = {
			mercenary = no
		}
	}

	can_use_title = {
		tier = count
		location = {
			NOT = { num_of_settlements = 1 }
		}
		FROM = {
			has_landed_title = PREV
		}
	}

	is_valid_title = {
		location = {
			NOT = { num_of_settlements = 1 }
		}
		FROM = {
			has_landed_title = PREV
		}
	}

	on_success_title = {
		usurp_title_plus_barony_if_unlanded = { target = ROOT type = invasion }
		
		ROOT = {
			show_scope_change = no
			participation_scaled_prestige = 100
			participation_scaled_piety = 50
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { 
				participation_scaled_prestige = 100 
				participation_scaled_piety = 50
			}
		}
	}

	on_fail_title = {
		ROOT = {
			show_scope_change = no
			prestige = -100
		}
		FROM = {
			show_scope_change = no
			participation_scaled_prestige = 50
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	on_reverse_demand = {
		ROOT = {
			show_scope_change = no
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
		}
		FROM = {
			show_scope_change = no
			participation_scaled_prestige = 100
			participation_scaled_piety = 50
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = {
				participation_scaled_prestige = 100 
				participation_scaled_piety = 50
			}
		}
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
	
	ai_will_do = {
		factor = 2
	}
	
}

# The CB used by "Minor Clan" revolters in Horse Lords
cb_minor_clan_revolt = {
	name = CB_NAME_MINOR_CLAN_REVOLT
	war_name = WAR_NAME_MINOR_CLAN_REVOLT
	sprite = 16
	truce_days = 365
	hostile_against_others = no
	is_permanent = yes
	check_all_titles = yes # if permanent, setting this to true will check against all of someones titles, including vassal held titles
	press_claim = yes
	
	attacker_can_call_allies = no
	defender_can_call_allies = no
	can_ask_to_join_war = no
	
	is_independence = yes
	
	can_use = {
		ROOT = {
			primary_title = { temporary = yes } # Revolter or adventurer trigger
			war = no
			NOT = { is_liege_or_above = FROM }
			mercenary = no
		}
	}

	can_use_title = {
		tier = count
	}

	is_valid_title = {
		OR = {
			FROM = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = FROM
			}
		}
	}

	on_success_title = {
		usurp_title_plus_barony_if_unlanded = { target = ROOT type = revolt }
	
		ROOT = {
			primary_title = {
				set_title_nomad = { title = THIS status = no }
			}
			
			set_government_type = feudal_government
		}
	
		ROOT = {		
			set_government_type = nomadic_government
			set_defacto_liege = FROM
			
			hidden_tooltip = {
				remove_opinion = {
					who = FROM
					modifier = opinion_evil_tyrant
				}
			}
		}
		FROM = {
			prestige = -100
		}
	}

	on_fail_title = {
		FROM = {
			prestige = 10
			hidden_tooltip = {
				opinion = {
					modifier = opinion_rebel_traitor 
					who = ROOT
					months = 1200
				}
			}
		}
		ROOT = {
			clear_wealth = yes
			imprison = FROM
			hidden_tooltip = {
				add_character_modifier = { 
					name = broken_spirit
					days = -1
				}
			}
		}
	}

	on_reverse_demand = {
		FROM = {
			prestige = 20
			hidden_tooltip = {
				opinion = {
					modifier = opinion_rebel_traitor 
					who = ROOT
					months = 1200
				}
				add_character_modifier = { 
					name = crushed_revolt
					days = 3650
				}
			}
		}
		ROOT = {
			clear_wealth = yes
			imprison = FROM 
			hidden_tooltip = {
				add_character_modifier = { 
					name = broken_spirit
					days = -1
				}
			}
		}
	}
	
	on_attacker_leader_death = {
		end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
}

# 
nomad_invasion = {
	name = CB_NAME_INVASION
	war_name = WAR_NAME_INVASION
	sprite = 8
	truce_days = 3650
	hostile_against_others = yes
	is_permanent = yes
	is_holy_war = yes
	can_ask_to_join_war = yes
	check_de_jure_tier = KING # this scans all de jure kingdoms for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes
	apply_short_occ_mod = no # Do not apply the 'recently_conquered' modifier to Holdings
	
	allowed_to_target_tributaries = no
	
	sort_priority = 1000
	
	can_use_gui = {
		ROOT = {
			prestige = 1000
			trigger_if = {
				limit = { is_nomadic = yes }
				population = 20000
				population_factor = 0.75 # 75% of max
			}
			trigger_else = {
				num_of_subrealm_tribes = 20
			}
		}
	}
	
	on_add = {
		ROOT = { prestige = -500 }
	}

	can_use = {
		ROOT = {
			TOW_is_creep_realm = yes
			OR = {
				ai = yes
				multiplayer = no
				NOT = {
					has_game_rule = {
						name = multiplayer_invasions
						value = off
					}
				}
			}
		}
		
		ROOT = {
			NOT = { same_realm = FROM }
		}
		
		OR = { # This ensures that the AI doesn't declare this type of war against someone who only holds a few counties within the targeted title...
			ROOT = {
				ai = no
			}
			FROM = {
				num_of_realm_counties = {
					value = 5
					title = PREV
				}
			}
		}
	}

	is_valid = {
		ROOT = {
			TOW_is_creep_realm = yes
		}
	}
	
	is_valid_title = {
		FROM = {
			any_realm_province = {
				de_jure_liege_or_above = PREVPREV
			}
		}
	}

	on_success = {
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 400 }
			set_character_flag = TOW_nomad_invasion_attacker
		}
		FROM = {
			prestige = -400
		}

		hidden_tooltip = {
			FROM = {
				any_realm_province = {
					limit = { controlled_by = ROOT }
					any_province_holding = {
						limit = { controlled_by = ROOT }
						set_title_flag = TOW_nomad_invasion_occupied
					}
				}
			}

			ROOT = {
				prestige = 1500

				if = {
					limit = {
						FROM = { is_nomadic = yes }
					}
					occupy_minors_of_occupied_settlements = FROM
					gain_all_occupied_titles = { who = FROM type = invasion }
				}
				
				if = {
					limit = {
						has_nickname = no
					}
					FROM = {
						save_event_target_as = nickname_target
					}
					ROOT = { 
						save_event_target_as = nickname_receiver
					}
					random_list = {
						5 = { give_nickname = nick_the_great }
						5 = { give_nickname = nick_the_victorious }
						5 = { give_nickname = nick_the_conqueror }
						5 = { give_nickname = nick_the_brave }
						10 = { give_nickname = nick_the_terrible }
						25 = { give_nickname = nick_the_despoiler }
						25 = { 
							give_nickname = nick_the_culture_marauder
							modifier = {
								factor = 0
								event_target:nickname_target = { is_nomadic = yes }
							}
							modifier = {
								factor = 0
								event_target:nickname_target = { culture = ROOT }
							}
						}
					}
				}
			}
		}
	}
	
	on_success_title = {
		if = {
			limit = {
				FROM = { TOW_is_creep_realm = no } # Creep targets get their lands stolen like vanilla invasion
			}

			if = { # Nomadic
				limit = { ROOT = { is_nomadic = yes } }
				ROOT = {
					primary_title = {
						ROOT = {
							custom_tooltip = { 
								text = TT_KHAN_INDEPENDENCE
							}
							most_prestigious_clan_vassal = {
								custom_tooltip = { 
									text = TT_NEW_KHAN
								}
							}
						}
					}
				}
			}

			# Select people who will want to follow
			ROOT = {
				any_realm_character = {
					limit = {
						is_ruler = yes
						has_character_flag = TOW_nomad_invasion_attacker
						NOR = {
							trait = craven
							trait = content
						}
						OR = {
							opinion = { who = ROOT value = -75 } # If I hate you, I won't come
							trait = deceitful
						}
						OR = {
							AND = {
								ROOT = { is_nomadic = yes }
								clan = yes
								NOT = { has_feud_with = ROOT }
								OR = {
									has_blood_oath_with = ROOT
									clan_opinion = { who = ROOT value = 50 }
									trait = ambitious
								}
							}
							AND = {
								ROOT = { is_nomadic = no }
								is_tribal = yes
								OR = {
									obedient = yes
									trait = ambitious
									opinion = { who = ROOT value = 50 }
									AND = {
										dynasty = ROOT
										opinion = { who = ROOT value = 25 }
									}
								}
								OR = {
									is_powerful_vassal = yes
									relative_power_to_liege = 0.3
									among_most_powerful_vassals = 3
								}
							}
						}
					}
					set_character_flag = TOW_nomad_invasion_invader
				}
			}

			any_character = {
				limit = { has_character_flag = TOW_nomad_invasion_attacker }
				clr_character_flag = TOW_nomad_invasion_attacker
			}

			save_event_target_as = conquered_title
			# New ruler & population calculation
			hidden_tooltip = {
				ROOT = {
					if = { # Nomadic
						limit = { is_nomadic = yes }

						ROOT = {
							export_to_variable = { which = TOW_invasion_population value = population }
						}
					}
					else = { # Tribal for people without HL DLC
						ROOT = {
							set_variable = { which = TOW_invasion_population value = 0 }
							any_realm_province = {
								ROOT = {
									export_to_variable = { which = local_province_pop value = num_of_max_settlements who = PREV }
									change_variable = { which = TOW_invasion_population which = local_province_pop }
								}
							}
							multiply_variable = { which = TOW_invasion_population value = 1000 }
						}
					}

					# Calculate leaving population factor
					ROOT = {
						export_to_variable = { which = TOW_leaving_population_factor value = prestige }
						divide_variable = { which = TOW_leaving_population_factor value = 15000 }
						if = { 
							limit = { check_variable = { which = TOW_leaving_population_factor value = 0.35 } }
							set_variable = { which = TOW_leaving_population_factor value = 0.35 }
						}
						random_list = {
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.35 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.36 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.37 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.38 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.39 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.40 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.41 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.42 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.43 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.44 } }
							1 = { change_variable = { which = TOW_leaving_population_factor value = 0.45 } }
						}
						multiply_variable = { which = TOW_invasion_population which = TOW_leaving_population_factor }
					}

					if = { # Nomadic
						limit = { is_nomadic = yes }

						ROOT = {
							primary_title = { save_event_target_as = nomadic_empire }
							TOW_set_creep_settled_playable_government = yes
						}
						event_target:nomadic_empire = {
							holder_scope = {
								set_variable = { which = TOW_invasion_population which = ROOT }
								# Remove leaving population
								multiply_variable = { which = TOW_invasion_population value = -1 }
								population = TOW_invasion_population
							}
						}
					}
					else = { # Tribal for people without HL DLC
						most_popular_vassal = {
							limit = { NOT = { has_character_flag = TOW_nomad_invasion_invader } }
							save_event_target_as = new_creep_ruler
						}
						if = {
							limit = { NOT = { event_target:new_creep_ruler = { is_alive = yes } } }
							Keitaro_create_random_courtier_gender_equality = yes
							new_character = {
								religion = ROOT
								culture = ROOT
               					TOW_initialize_adult_character = yes
								save_event_target_as = new_creep_ruler
							}
						}

						ROOT = {
							any_demesne_title = {
								grant_title_no_opinion = event_target:new_creep_ruler
							}
						}

						TOW_set_creep_settled_playable_government = yes
					}
				}

				# Set new capital province
				FROM = {
					random_realm_province = {
						limit = { kingdom = { title = event_target:conquered_title } }
						preferred_limit = { event_target:conquered_title = { capital_scope = { province = PREVPREV } } } # Take new kingdom capital in priority
						preferred_limit = { event_target:conquered_title = { any_direct_de_jure_vassal_title = { capital_scope = { province = PREVPREVPREV } } } } # Capital of a duchy
						preferred_limit = { num_of_max_settlements = 7 }
						preferred_limit = { num_of_max_settlements = 6 }
						preferred_limit = { num_of_max_settlements = 5 }
						preferred_limit = { num_of_max_settlements = 4 }
						preferred_limit = { num_of_max_settlements = 3 }
						preferred_limit = { num_of_max_settlements = 2 }

						save_event_target_as = new_capital
					}
				}

				if = {
					limit = { has_holder = no }
					grant_title = ROOT
					make_primary_title = yes
				}
				else = {
					any_title = {
						limit = {
							tier = king
							has_title_flag = Keitaro_cultural_custom_title
							persistent_event_target:Keitaro_custom_title_founder = { culture = ROOT }
						}
						ROOT = { set_flag = Keitaro_cultural_custom_title_impossible }
					}
					any_title = {
						limit = {
							tier = king
							has_title_flag = Keitaro_dynastic_custom_title
							persistent_event_target:Keitaro_custom_title_founder = { dynasty = ROOT }
						}
						ROOT = { set_flag = Keitaro_dynastic_custom_title_impossible }
					}

					# Create a new kingdom
					event_target:new_capital = {
						county = {
							event_target:conquered_title = { save_event_target_as = name_title }
							create_title = {
								tier = KING
								landless = no
								temporary = no
								custom_created = yes
								culture = ROOT
								holder = ROOT
								name = CUSTOM_KINGDOM_CREEP
							}
							# Naming flavor
							new_title = {
								save_event_target_as = new_title
								# Name
								random_list = {
									20 = {
										modifier = {
											factor = 0
											ROOT = { has_flag = Keitaro_cultural_custom_title_impossible }
										}
										# Need a way to store culture, paradox
										set_name = CUSTOM_KINGDOM_CULTURAL
										set_short_name = yes
										set_title_flag = Keitaro_cultural_custom_title
										save_persistent_event_target = { name = Keitaro_custom_title_founder scope = ROOT }
									}
									10 = {
										modifier = {
											factor = 0
											ROOT = { has_flag = Keitaro_dynastic_custom_title_impossible }
										}
										set_name = CUSTOM_KINGDOM_DYNASTIC
										set_short_name = yes
										set_title_flag = Keitaro_dynastic_custom_title
										save_persistent_event_target = { name = Keitaro_custom_title_founder scope = ROOT }
									}
								}
								make_primary_title = yes
							}
						}
					}
				}

				ROOT = {
					any_demesne_title = {
						limit = {
							OR = {
								AND = {
									tier = KING
									is_primary_holder_title = no
								}
								tier = EMPEROR
							}
						}
						destroy_landed_title = THIS
					}
				}

				# Vassalize invaded lands
				ROOT = { vassalize_or_take_under_title_destroy_duchies = { title = PREV enemy = FROM } }

				# Capital
				event_target:new_capital = {
					if = {
						limit = { has_province_flag = TOW_nomad_invasion_occupied }
						ROOT = { subtract_variable = { which = TOW_invasion_population value = 1250 } }
						clr_province_flag = TOW_nomad_invasion_occupied
					}
					else = { ROOT = { subtract_variable = { which = TOW_invasion_population value = 1500 } } }
					set_province_flag = TOW_nomad_invasion_province
					county = { save_persistent_event_target = { name = TOW_nomad_invasion_receiver scope = ROOT } }

					any_province_holding = {
						limit = { is_capital = no }
						if = {
							limit = { has_title_flag = TOW_nomad_invasion_occupied }
							ROOT = { subtract_variable = { which = TOW_invasion_population value = 750 } }
							clr_title_flag = TOW_nomad_invasion_occupied
						}
						else = { ROOT = { subtract_variable = { which = TOW_invasion_population value = 1000 } } }
						set_title_flag = TOW_nomad_invasion_holding
					}
					ROOT = { capital = PREV }
				}

				ROOT = {
					# Set provinces where population settles
					while = {
						limit = { check_variable = { which = TOW_invasion_population value = 1000 } }
						random_realm_province = {
							limit = {
								kingdom = { title = event_target:conquered_title }
								NOT = { has_province_flag = TOW_nomad_invasion_province }
								NOT = { culture = ROOT }
								num_of_settlements = 1
								any_neighbor_province = {
									OR = {
										has_province_flag = TOW_nomad_invasion_province
										is_land = no
									}
								}
							}

							if = {
								limit = { has_province_flag = TOW_nomad_invasion_occupied }
								ROOT = { change_variable = { which = TOW_invasion_population value = 250 } }
								clr_province_flag = TOW_nomad_invasion_occupied
							}

							set_province_flag = TOW_nomad_invasion_province
							any_province_holding = {
								limit = { is_capital = no }
								if = {
									limit = { ROOT = { check_variable = { which = TOW_invasion_population value = 1000 } } }
									if = {
										limit = { has_title_flag = TOW_nomad_invasion_occupied }
										ROOT = { subtract_variable = { which = TOW_invasion_population value = 750 } }
										clr_title_flag = TOW_nomad_invasion_occupied
									}
									else = { ROOT = { subtract_variable = { which = TOW_invasion_population value = 1000 } } }
									set_title_flag = TOW_nomad_invasion_holding
								}
							}
						}
						subtract_variable = { which = TOW_invasion_population value = 1000 }
					}

					# Select counties holders
					any_realm_province = {
						limit = { has_province_flag = TOW_nomad_invasion_province NOT = { province = event_target:new_capital } }

						# Select receiver
						ROOT = {
							random_courtier = {
								limit = {
									NOT = { has_character_flag = TOW_nomad_invasion_receiving_county }
									NOT = { is_main_spouse = ROOT }
									NOT = { is_consort = ROOT }
									NOT = { ROOT = { any_spouse = { character = PREVPREV } } }
									culture = ROOT
									religion = ROOT
									is_ruler = no
									has_job_title = no
								}
								preferred_limit = { has_character_flag = TOW_nomad_invasion_invader }
								preferred_limit = { has_minor_title = title_commander }
								preferred_limit = { is_close_relative = ROOT }
								save_event_target_as = title_receiver
							}
							if = {
								limit = {
									NOT = { event_target:title_receiver = { is_alive = yes } }
								}
								save_event_target_as = employer
								Keitaro_create_random_courtier_gender_equality = yes
								new_character = {
									religion = ROOT
									culture = ROOT
               						TOW_initialize_adult_character = yes
									save_event_target_as = title_receiver
								}
							}
						}
						event_target:title_receiver = { set_character_flag = TOW_nomad_invasion_receiving_county }
						county = { save_persistent_event_target = { name = TOW_nomad_invasion_receiver scope = event_target:title_receiver } }
						clear_event_target = title_receiver
					}

					# Settle and usurp counties
					any_realm_province = {
						limit = { has_province_flag = TOW_nomad_invasion_province }
						capital_holding = {
							TOW_conquered_holding_effect = yes
						}
						
						any_province_holding = {
							limit = { is_capital = no has_title_flag = TOW_nomad_invasion_holding }
							# Select receiver
							ROOT = {
								random_courtier = {
									limit = {
										NOT = { has_character_flag = TOW_nomad_invasion_receiving_county }
										NOT = { is_main_spouse = ROOT }
										NOT = { is_consort = ROOT }
										NOT = { ROOT = { any_spouse = { character = PREVPREV } } }
										culture = ROOT
										religion = ROOT
										is_ruler = no
										has_job_title = no
									}
									preferred_limit = { has_character_flag = TOW_nomad_invasion_invader }
									preferred_limit = { has_minor_title = title_commander }
									preferred_limit = { is_close_relative = ROOT }
									save_event_target_as = title_receiver
								}
								if = {
									limit = {
										NOT = { event_target:title_receiver = { is_alive = yes } }
									}
									save_event_target_as = employer
									Keitaro_create_random_courtier_gender_equality = yes
									new_character = {
										religion = ROOT
										culture = ROOT
               							TOW_initialize_adult_character = yes
										save_event_target_as = title_receiver
									}
								}
							}
							event_target:title_receiver = {
								if = {
									limit = { NOT = { character = ROOT } is_ruler = yes }
									TOW_abandon_current_titles = yes
								}
							}
							holder_scope = { save_event_target_as = title_owner }
							usurp_title = { target = event_target:title_receiver type = invasion }
							add_claim = event_target:title_owner
							TOW_conquered_holding_effect = yes
							event_target:title_receiver = { opinion = { modifier = opinion_granted_barony who = ROOT years = 30 } }
							clear_event_target = title_receiver
							clr_title_flag = TOW_nomad_invasion_holding
						}

						county = {
							holder_scope = { save_event_target_as = title_owner }
							persistent_event_target:TOW_nomad_invasion_receiver = {
								if = {
									limit = { NOT = { character = ROOT } is_ruler = yes }
									TOW_abandon_current_titles = yes
								}
							}
							usurp_title = { target = persistent_event_target:TOW_nomad_invasion_receiver type = invasion }
							persistent_event_target:TOW_nomad_invasion_receiver = {
								opinion = { modifier = opinion_granted_county who = ROOT years = 30 }
								clr_character_flag = TOW_nomad_invasion_receiving_county
							}
							add_claim = event_target:title_owner
							clear_persistent_event_target = TOW_nomad_invasion_receiver
							clear_event_target = title_owner
						}
						TOW_conquered_province_effect = yes
					}
				}

				ROOT = {
					any_realm_province = {
						limit = { has_province_flag = TOW_nomad_invasion_province }
						if = {
							limit = { NOT = { culture = ROOT } }
							culture = ROOT
						}
						if = {
							limit = { NOT = { religion = ROOT } }
							religion = ROOT
						}
						clr_province_flag = TOW_nomad_invasion_province
					}
				}

				# Army
				ROOT = { 
					if = {
						limit = { NOT = { check_variable = { which = TOW_invasion_population value = 0 } } }
						set_variable = { which = TOW_invasion_population value = 0 }
					}
					change_variable = { which = TOW_invasion_population value = 1500 }
					# Spawn conquering army
					while = {
						limit = {
							check_variable = { which = TOW_invasion_population value = 300 }
						}

						spawn_unit = {
							province = event_target:new_capital
							owner = THIS
							troops = {
								light_infantry = { 100 100 }
								archers = { 50 50 }
							}
							attrition = 1
							merge = yes
						}
						subtract_variable = { which = TOW_invasion_population value = 300 }
					}
				}

				set_variable = { which = TOW_invasion_population value = 0 }
				set_variable = { which = TOW_leaving_population_factor value = 0 }

			}
		}
		else = {
			custom_tooltip = {
				text = tribal_invasion_succ_tip
				hidden_tooltip = {
					ROOT = {
						vassalize_or_take_under_title = {
							title = event_target:conquered_title
							enemy = FROM
						}
					}
				}
			}
		}
	}

	on_fail = {
		FROM = {
			prestige = 100
			
			hidden_tooltip = {
				if = {
					limit = {
						has_nickname = no
					}
					random_list = {
						10 = { give_nickname = nick_the_great }
						10 = { give_nickname = nick_the_hammer }
						10 = { give_nickname = nick_the_avenger }
						10 = { give_nickname = nick_the_bold }
					}
				}
			}
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
		ROOT = {
			prestige = -200
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
		}
		FROM = {
			prestige = 200
			hidden_tooltip = {
				if = {
					limit = {
						has_nickname = no
					}
					random_list = {
						10 = { give_nickname = nick_the_great }
						10 = { give_nickname = nick_the_hammer }
						10 = { give_nickname = nick_the_avenger }
						10 = { give_nickname = nick_the_bold }
					}
				}
			}
			
			participation_scaled_prestige = 200
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}
	}

	attacker_ai_victory_worth = {
		factor = 200
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
	
	ai_will_do = { 
		factor = 8
		
		modifier = {
			factor = 0.9 # Prefer using CB's without on_add costs
		}
	}
}

# Nomads can grab entire duchies, if they have the Prestige
nomad_expansion = {
	name = CB_NAME_NOMAD_EXPANSION
	war_name = WAR_NAME_NOMAD_EXPANSION
	sprite = 8
	truce_days = 3650
	is_permanent = yes
	is_holy_war = yes
	check_de_jure_tier = DUKE # this scans all de jure duchies for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes

	allowed_to_target_tributaries = no
	
	sort_priority = 800
	
	can_use_gui = {
		ROOT = {
			prestige = 300
			TOW_is_creep_realm = yes
			population_factor = 0.5
		}
		FROM = {
			
			OR = {
				is_nomadic = yes # Nomads no population requirement
				AND = {
					is_tribal = yes
					ROOT = { population = 5000 } # Tribals need 5k
				}
				ROOT = { population = 15000 } # Everyone else needs 15k
			}
		}
	}
	
	on_add = {
		ROOT = { prestige = -300 }
	}

	can_use = {
		ROOT = {
			is_nomadic = yes
			NOT = { same_realm = FROM }
			mercenary = no
		}
	}
	
	can_use_title = {
		# The attacker needs at least one county in the target duchy, or a border
		any_direct_de_jure_vassal_title = {
			OR = {
				holder_scope = {
					OR = {
						character = ROOT
						is_liege_or_above = ROOT
					}
				}
				location = {
					any_neighbor_province = {
						has_owner = yes
						owner = {
							OR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
				}
			}
		}
	}

	is_valid = {
		ROOT = {
			NOR = {
				pays_tribute_to = FROM
				any_liege = {
					OR = {
						pays_tribute_to = FROM
						FROM = {
							pays_tribute_to = PREV
						}
					}
				}
			}
			is_nomadic = yes
			NOT = { same_realm = FROM }
		}
	}
	
	on_success = {
		ROOT = {
			if = {
				limit = {
					has_nickname = no
				}
				FROM = {
						save_event_target_as = nickname_target
					}
				ROOT = { 
					save_event_target_as = nickname_receiver
				}
				random_list = {
					5 = { give_nickname = nick_the_despoiler }
					5 = {
						give_nickname = nick_the_culture_marauder
						modifier = {
							factor = 0
							event_target:nickname_target = { is_nomadic = yes }
						}
						modifier = {
							factor = 0
							event_target:nickname_target = { culture = ROOT }
						}
					}
					5 = { 
						give_nickname = nick_the_bane_of_realmname
						modifier = {
							factor = 0
							event_target:nickname_target = { is_nomadic = yes }
						}
						modifier = {
							factor = 0
							event_target:nickname_target = { culture = ROOT }
						}
					}
					5 = { 
						give_nickname = nick_the_slayer_of_culture
						modifier = {
							factor = 0
							event_target:nickname_target = { culture = ROOT }
						}
					}
					100 = { }
				}
			}
			if = {
				limit = {
					uses_decadence = yes
				}
				participation_scaled_decadence = -10
			}
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { 
				participation_scaled_prestige = 200
				if = {
					limit = {
						uses_decadence = yes
					}
					participation_scaled_decadence = -10
				}
			}
		}
		FROM = { prestige = -200 }
	}

	on_success_title = {
		custom_tooltip = {
			text = pagan_subjugation_tip
			hidden_tooltip = {
				ROOT = {
					subjugate_or_take_under_title = {
						title = PREV
						enemy = FROM
					}
				}
			}
		}
	}

	on_fail = {
		ROOT = { 
			prestige = -200
		}
	}

	on_reverse_demand = {
		ROOT = {
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
			prestige = -200
		}
		FROM = {
			participation_scaled_prestige = 300
			if = {
				limit = {
					uses_decadence = yes
				}
				participation_scaled_decadence = -10
			}
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { 
				participation_scaled_prestige = 300
				if = {
					limit = {
						uses_decadence = yes
					}
					participation_scaled_decadence = -10
				}
			}
		}
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
	
	ai_will_do = { 
		factor = 2
	}
}

# 
nomad_humiliate_cb = {
	name = CB_NAME_HUMILIATE
	war_name = WAR_NAME_HUMILIATE
	sprite = 1
	truce_days = 3650
	is_permanent = yes
	hostile_against_others = yes
	can_ask_to_join_war = no
	display_on_map = no
	allowed_to_target_tributaries = no
	
	defender_unoccupied_warscore = yes
	
	sort_priority = 815
	
	can_use_gui = {
		check_if_crusader_trigger = yes
	}

	can_use = {
		has_dlc = "Horse Lords"
		
		FROM = {
			is_nomadic = yes
			culture = ROOT
		}

		ROOT = {
			is_nomadic = yes
			mercenary = no
			OR = {
				AND = {
					same_realm = FROM
					has_feud_with = FROM
				}
				FROM = {
					is_nomadic = yes
					independent = yes
				}
			}
		}
		
		# The attacker needs a border, or be at most two sea zones away from one of the target's counties
		FROM = {
			any_realm_province = {
				any_neighbor_province = {
					OR = {
						AND = {
							has_owner = yes
							owner = {
								OR = {
									character = ROOT
									is_liege_or_above = ROOT
								}
							}
						}
						AND = {
							is_land = no
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												is_liege_or_above = ROOT
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											owner = {
												OR = {
													character = ROOT
													is_liege_or_above = ROOT
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}

	on_success = {
		ROOT = {
			prestige = 300
			steal_population_scaled = {
				target = FROM
				percentage = 0.25
			}
		}
		FROM = {
			prestige = -300
		}
	}

	on_fail = {
		ROOT = {
			prestige = -100
		}
		FROM = {
			prestige = 100
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
		}

		FROM = {
			prestige = 200
		}
	}
	
	on_attacker_leader_death = {
		end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
		
		modifier = {
			factor = 2
			FROM = {
				trait = proud
			}
		}
		
		modifier = {
			factor = 2
			FROM = {
				trait = brave
			}
		}
		
		modifier = {
			factor = 2
			FROM = {
				trait = greedy
			}
		}
		
		modifier = {
			factor = 3
			FROM = {
				tier = KING
			}
		}

		modifier = {
			factor = 0.85
			ROOT = {
				relative_power = { who = FROM power = 1.2 }
			}
		}

		modifier = {
			factor = 0.85
			ROOT = {
				relative_power = { who = FROM power = 1.5 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 2.0 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 2.5 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 3 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 4 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 5 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 6 }
			}
		}

		modifier = {
			factor = 0.5
			ROOT = {
				relative_power = { who = FROM power = 8 }
			}
		}

		modifier = {
			factor = 0.25
			ROOT = {
				relative_power = { who = FROM power = 10 }
			}
		}

		modifier = {
			factor = 2
			ROOT = {
				distance_from_realm = { who = FROM value = 20 }
			}
		}

		modifier = {
			factor = 2
			ROOT = {
				distance_from_realm = { who = FROM value = 40 }
			}
		}
		
		modifier = {
			factor = 3
			ROOT = {
				distance_from_realm = { who = FROM value = 80 }
			}
		}
		
		modifier = {
			factor = 4
			ROOT = {
				distance_from_realm = { who = FROM value = 120 }
			}
		}
	}

	ai_will_do = {
		factor = 1
		
		modifier = {
			factor = 0.1 # Low prio CB
		}
		
		modifier = {
			factor = 0.1 # Target has almost no money
			FROM = {
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
			}
		}

		modifier = {
			factor = 4
			ROOT = {
				trait = greedy
			}
		}
	}
}

# 57
cb_install_khan = {
	name = CB_NAME_INSTALLKHAN
	war_name = WAR_NAME_INSTALLKHAN
	sprite = 12
	truce_days = 3650
	
	is_revolt_cb = no
	can_call_vassals = yes
	attacker_can_call_allies = no
	major_revolt = yes

	can_use = {
		has_dlc = "Horse Lords"
		
		ROOT = {
			TOW_is_creep_realm = yes
		}
	}

	is_valid = {
		ROOT = {
			OR = {
				liege = {
					character = PREV # either independent
				}
				liege = { 
					FROM = { 
						is_liege_or_above = PREV # or have shared liege
					}
				}
			}
			any_demesne_title = {
				tier = count # has some land
			}
		}
		FROM = {
			any_demesne_title = {
				NOT = { lower_tier_than = ROOT }
				temporary = no
			}
		}
	}

	on_success = {
		FROM = {
			any_demesne_title = {
				limit = { tier = EMPEROR }
				gain_title = { target = ROOT type = faction_demand }
			}
			death = {
				death_reason = death_execution
				killer = ROOT
			}
		}
		ROOT = {
			participation_scaled_prestige = 250
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 250 }
		}
	}

	on_fail = {
		ROOT = {
			show_scope_change = no
			prestige = -100
		}
	}

	on_reverse_demand = {
		ROOT = {
			show_scope_change = no
			prestige = -200
			prisoner = FROM
		}
		FROM = {
			show_scope_change = no
			participation_scaled_prestige = 50
			hidden_tooltip = { 
				if = { 
					limit = { NOT = { has_opinion_modifier = { modifier = opinion_traitor who = ROOT } } } #Allow free revocation of a title.
					opinion = {
						who = ROOT
						modifier = opinion_traitor
					}
				}
			}
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}
	
	on_defender_leader_death = {
		hidden_tooltip = {
			any_attacker = {
				letter_event = {
					id = 251
				}
			}
		}
		
		end_war = invalid
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
}

cb_colonize_creeps = {
	name = CB_NAME_COLONIZE_CREEPS
	war_name = WAR_NAME_COLONIZE_CREEPS
	sprite = 16
	truce_days = 1825
	is_permanent = yes
	is_holy_war = no
	check_all_titles = yes # if permanent, setting this to true will check against all of someones titles, including vassal held titles
	can_ask_to_join_war = no
	infamy_modifier = 0.75
	apply_short_occ_mod = no # Do not apply the 'recently_conquered' modifier to Holdings
	
	sort_priority = 690

	can_use_gui = {
		ROOT = {
			show_scope_change = no
			scaled_wealth = { value = 3.0 min = 100 }
		}
	}
	
	on_add = {
		ROOT = {
			show_scope_change = no
			scaled_wealth = { value = -3.0 min = -100 }
		}
	}
	
	can_use = {
		ROOT = {
			NOT = { is_liege_or_above = FROM }
			mercenary = no
			NOT = { pacifist = yes }
			TOW_is_creep_realm = no
		}
		FROM = {
			TOW_is_creep_realm = yes
		}
	}

	can_use_title = {
		tier = count
		OR = {
			FROM = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = FROM
				NOT = { same_realm = ROOT }
			}
		}

		NOR = {
			ROOT = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = ROOT
			}
		}

		OR = {
			AND = {
				location = {
					any_neighbor_province = {
						owner = {
							OR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
				}
				OR = {
					custom_tooltip = {
						text = province_not_capital_tooltip
						hidden_tooltip = {
							FROM = {
								capital_scope = {
							    	county = {
							    		NOT = { title = PREVPREVPREV }
							    	}
							  	}
							}
						}
					}
					NOT = { num_title_realm_provs = { who = FROM value = 2 } }
				}
			}
			#AND = {
			#	FROM = { # Capital bordering ROOT
			#		capital_scope = {
			#			any_neighbor_province = {
			#				owner = {
			#					OR = {
			#						character = ROOT
			#						is_liege_or_above = ROOT
			#					}
			#				}
			#			}
			#		}
			#	}
			#	NOT = { # No other province is bordering ROOT
			#		any_realm_province = {
			#			any_neighbor_province = {
			#				owner = {
			#					OR = {
			#						character = ROOT
			#						is_liege_or_above = ROOT
			#					}
			#				}
			#			}
			#		}
			#	}
			#	any_neighbor_province = {
			#		OR = {
			#			is_land = no
			#			NOR = {
			#				owner = { character = FROM }
			#				owner = { is_liege_or_above = FROM }
			#			}
			#		}
			#	}
			#}
		}
	}

	is_valid_title = {
		OR = {
			FROM = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = FROM
			}
		}
	}

	on_success_title = {
		usurp_title_plus_barony_if_unlanded = { target = ROOT type = invasion }
		any_de_jure_vassal_title = { # take all baronies under the one we're fighting for
			limit = {
				has_holder = yes
				NOT = {
					de_facto_liege = PREV
				}
				holder_scope = {
					is_liege_or_above = FROM
				}
			}

			usurp_title_plus_barony_if_unlanded = { target = ROOT type = invasion }
		}

		location = {
			province_event = { id = TOW_Colony.1 } # Create Colony
			if = {
				limit = { ROOT = { FROM = { TOW_is_same_race_as_prev = no } } } # Can't have murlocs modifiers in murloc realms
				FROM = { save_event_target_as = creep_race_character }
				TOW_province_add_creeps_3 = yes
			}
		}
		
		add_pressed_claim = FROM
		
		ROOT = {
			show_scope_change = no
			participation_scaled_prestige = 100
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
	}

	on_fail_title = {
		ROOT = {
			show_scope_change = no
			prestige = -100
		}
		FROM = {
			show_scope_change = no
			participation_scaled_prestige = 50
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	on_reverse_demand = {
		ROOT = {
			show_scope_change = no
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
		}
		FROM = {
			show_scope_change = no
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
	}
	
	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
	
	ai_will_do = { 
		factor = 1
		
		modifier = {
			factor = 0.7 # Prefer using CB's without on_add costs
		}
		modifier = {
			factor = 0
			ROOT = {
				independent = no
				same_liege = FROM
			}
		}
		modifier = {
			factor = 0
			ROOT = {
				higher_tier_than = DUKE
				num_of_count_titles_in_realm = 10
			}
		}
		modifier = {
			factor = 0
			ROOT = {
				OR = {
					trait = just
					trait = content
				}
			}
		}
		modifier = {
			factor = 0
			ROOT = {
				NOR = {
					trait = arbitrary
					trait = ambitious
				}
			}
		}
	}
}