namespace = magic

#Set up the magic variable
character_event = {
    id = magic.1
    hide_window = yes

    mean_time_to_happen = {
        days = 1
    }

    trigger = {
        NOT = { has_character_modifier = magic_counter }
        OR = {
            trait = arcanist
            trait = necrolyte
            trait = mage
            trait = warlock
            trait = necromancer
            trait = runemaster
            trait = priest
            trait = shaman
            trait = druid
            trait = witch_doctor
            trait = techmage
			trait = paladin
        }
    }

    immediate = {
		set_variable = { which = mana value = 0 }
		character_event = { id = magic.2 } # To calculate the cap, should run every now and then. yearly pulse?
		change_variable = { which = mana which = mana_cap }
		add_character_modifier = { modifier = magic_counter duration = -1 }
    }
}

#Cap calculation
character_event = {
    id = magic.2
    hide_window = yes

    is_triggered_only = yes

    immediate = {
        set_variable = { which = mana_cap value = 0 }
        set_variable = { which = counter value = 0 }
        set_variable = { which = cap value = 0 }
        export_to_variable = { which = cap value = learning }
        while = {
            limit = {
                NOT = { check_variable = { which = counter which = cap } }
            }
            change_variable = { which = mana_cap value = 5 } # Change later if need be
            change_variable = { which = counter value = 1 }
        }
        if = {
            limit = {
                trait = erudite
            }
            change_variable = { which = mana_cap value = 5 }
        }
        if = {
            limit = {
                trait = scholar
            }
            change_variable = { which = mana_cap value = 5 }
        }
        if = {
            limit = {
                trait = scholar
            }
            change_variable = { which = mana_cap value = 5 }
        }
		if = {
            limit = {
                trait = scholarly_theologian
            }
            change_variable = { which = mana_cap value = 5 }
        }
		if = {
            limit = {
                trait = mastermind_theologian
            }
            change_variable = { which = mana_cap value = 10 }
        }
        if = {
            limit = {
                OR = {
					trait = quick
					trait = shrewd
				}
            }
            change_variable = { which = mana_cap value = 5 }
        }
		if = {
            limit = {
                trait = genius
            }
            change_variable = { which = mana_cap value = 10 }
        }
		if = {
            limit = {
                OR = {
					trait = high_elf
					trait = blood_elf
					trait = gnome
					trait = draenei
					trait = broken
					trait = lost_one
					trait = troll_zandalari
					trait = secret_dragon
					trait = ogre_magi
				}
            }
            change_variable = { which = mana_cap value = 5 }
        }
		if = {
            limit = {
                trait = eredar
            }
			change_variable = { which = mana_cap value = 10 }
        }
		if = {
			limit = {
				trait = guardian_of_tirisfal
			}
			change_variable = { which = mana_cap value = 25 } # Guardians be powerful
		}
		if = {
			limit = {
				OR = {
					trait = mage
					trait = warlock
					trait = necromancer
					trait = runemaster
					trait = priest
					trait = shaman
					trait = druid
					trait = witch_doctor
					trait = techmage
					trait = paladin
				}
			}
			change_variable = { which = mana_cap value = 5 }
		}
    }
}

character_event = { # Very simplistic, but it works. Will likely improve it later.
	id = magic.3
	hide_window = yes
	
	mean_time_to_happen = {
		days = 60
		modifier = {
			factor = 0.75
			OR = {
				trait = mage
				trait = warlock
				trait = necromancer
				trait = runemaster
				trait = priest
				trait = shaman
				trait = druid
				trait = witch_doctor
				trait = techmage
				trait = paladin
			}
		}
		modifier = {
			factor = 0.9
			learning = 17
			NOT = { learning = 20 }
		}
		modifier = {
			factor = 0.75
			learning = 20
		}
		modifier = {
			factor = 0.75
			trait = guardian_of_tirisfal
		}
	}
	
	trigger = {
		has_character_modifier = magic_counter
		NOT = { check_variable = { which = mana which = mana_cap } }
	}
	
	immediate = {
		random_list = {
			18 = {
				change_variable = { which = mana value = 2 }
			}
			9 = {
				change_variable = { which = mana value = 4 }
			}
			8 = {
				change_variable = { which = mana value = 5 }
			}
			4 = {
				change_variable = { which = mana value = 10 }
			}
			3 = {
				change_variable = { which = mana value = 15 }
			}
			2 = {
				change_variable = { which = mana value = 20 }
			}
		}
		if = {
			limit = {
				check_variable = { which = mana which = mana_cap }
				NOT = { is_variable_equal = { which = mana which = mana_cap } }
			}
			set_variable = { which = mana which = mana_cap }
		}
	}
}