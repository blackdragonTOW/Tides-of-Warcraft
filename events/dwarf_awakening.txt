namespace = dwarfnator

#Couldn't resist the namespace.

#Set up, invisible.
character_event = {
	id = dwarfnator.1
	hide_window = yes
	
	mean_time_to_happen = {
		years = 250
		modifier = {
			factor = 0.4
			year = 7400
		}
		modifier = {
			factor = 0.01
			year = 7500
		}
	}
	
	trigger = {
		has_global_flag = trollwars_bookmark
		NOT = { has_global_flag = dwarf_awakening_start }
		year = 7250
		NOT = {
			has_game_rule = {
				name = troll_wars_events
				value = off
			}
		}
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_start
	}
}

#Troggs start to appear in provinces.
province_event = {
	id = dwarfnator.2
	desc = EVTDESCDWRF.2 # Strange brutish creatures have begun appearing all over the region! Some of your people have begun to call them troggs, but that only gives a name to this new menace.
	picture = "GFX_evt_creeps" # Could use a better one if someone could find a good trogg picture.
	border = "GFX_event_normal_frame_war"
	
	mean_time_to_happen = {
		months = 80
		modifier = {
			factor = 0.2
			terrain = mountain
		}
	}
	
	trigger = {
		has_global_flag = dwarf_awakening_start
		NOT = { has_global_flag = dwarf_armies_spawned }
	}
	
	option = {
		name = EVTOPTDWRF.2 # Foul beasts! Rally!
		random_realm_province = {
			limit = {
				OR = {
					terrain = mountain
					terrain = hills
				}
			}
			create_character = {
				random_traits = yes
				trait = trogg
				culture = trogg
				religion = geomancy
				employer = THIS
				age = 20
			}
			new_character = {
				create_title = {
					tier = DUKE
					landless = yes
					temporary = yes
					rebel = yes
					name = MONSTER_HORDE
					culture = trogg
					holder = THIS
				}
				random_list = {
					20 = {
						spawn_unit = {
							province = PREV
							home = PREV
							owner = THIS
							leader = THIS
							scaled_by_biggest_garrison = 1.5
							troops = {
								light_infantry = { 10 10 }
								heavy_infantry = { 5 5 }
							}
							attrition = 1.0
						}
					}
					10 = {
						spawn_unit = {
							province = PREV
							home = PREV
							owner = THIS
							leader = THIS
							scaled_by_biggest_garrison = 1
							troops = {
								light_infantry = { 5 5 }
								heavy_infantry = { 5 5 }
							}
							attrition = 1.0
						}
					}
					10 = {
						spawn_unit = {
							province = PREV
							home = PREV
							owner = THIS
							leader = THIS
							scaled_by_biggest_garrison = 1
							troops = {
								light_infantry = { 10 10 }
								heavy_infantry = { 5 5 }
							}
							attrition = 1.0
						}
					}
					10 = {
						spawn_unit = {
							province = PREV
							home = PREV
							owner = THIS
							leader = THIS
							scaled_by_biggest_garrison = 0.7
							troops = {
								light_infantry = { 8 8 }
								heavy_infantry = { 4 4 }
							}
							attrition = 1.0
						}
					}
				}
			}
			duchy = {
				new_character = {
					war = {
						target = ROOT
						casus_belli = invasion # change this later
						thirdparty_title = PREV
					}
				}
			}
		}
	}
}

#Dwarves are spawned, DoW whomever holds IF and surroundings.
narrative_event = {
	id = dwarfnator.3
	title = EVTTITLEDWRF.3 # The Bearded Host
	desc = EVTDESCDWRF.3 # Reports reach you of a concerning development in the Badlands. The old ruins of Uldaman have been unsealed, seemingly from within, and from its depths march out three great armies of stout, if short, bearded humanoids. Worse, they march your way!
	picture = "GFX_evt_dwarves" # Placeholder
	border = "GFX_event_narrative_frame_war"
	
	mean_time_to_happen = {
		years = 12
	}
	
	trigger = {
		has_global_flag = dwarf_awakening_start
		NOT = { has_global_flag = dwarf_armies_spawned }
		OR = {
			AND = {
				has_landed_title = c_ironforge
				independent = yes
			}
			any_realm_character = {
				has_landed_title = c_ironforge
			}
		}
	}
	
	option = {
		name = EVTOPTDWRF.3 # We will defend ourselves from these... dwarves.
		save_event_target_as = dwarf_awakening_defender
		c_uldaman = {
			location = {
				create_character = {
					random_traits = yes
					trait = AK_trait_dwarf
					dynasty = 100804
					culture = bronzebeard
					religion = geomancy
					age = 50
					employer = THIS
					attributes = {
						diplomacy = 18
					}
				}
				new_character = {
					save_event_target_as = anvilmar_leader
					wealth = 500
					create_title = {
						tier = DUKE
						landless = yes
						temporary = yes
						name = DWARF_HOST
						culture = bronzebeard
						holder = THIS
					}
					create_character = {
						random_traits = yes
						trait = AK_trait_dwarf
						dynasty = 100801
						culture = bronzebeard
						religion = geomancy
						employer = PREV
						age = 50
						attributes = {
							martial = 18
							diplomacy = 12
						}
					}
					new_character = {
						save_event_target_as = bronzebeard_leader
						spawn_unit = {
							province = 314 # Uldaman
							leader = THIS
							owner = THIS
							troops = {
								light_infantry = { 1000 1000 }
								heavy_infantry = { 700 700 }
								archers = { 300 300 }
							}
							attrition = 0
							reinforces = no
							earmark = dwarf_awakening_troops
						}
					}
					create_character = {
						random_traits = yes
						trait = AK_trait_dwarf
						dynasty = 100803
						culture = wildhammer
						religion = aeromancy
						employer = PREV
						age = 50
						attributes = {
							martial = 15
							learning = 13
						}
					}
					new_character = {
						save_event_target_as = wildhammer_leader
						wealth = 500
						spawn_unit = {
							province = 314 # Uldaman
							leader = THIS
							owner = THIS
							troops = {
								light_infantry = { 1100 1100 }
								heavy_infantry = { 500 500 }
								archers = { 400 400 }
							}
							attrition = 0
							reinforces = no
							earmark = dwarf_awakening_troops
						}
					}
					create_character = {
						random_traits = yes
						trait = AK_trait_dwarf
						dynasty = 100802
						culture = dark_iron
						religion = pyromancy
						employer = PREV
						age = 50
						attributes = {
							martial = 15
							intrigue = 12
						}
					}
					new_character = {
						save_event_target_as = darkiron_leader
						wealth = 500
						spawn_unit = {
							province = 314 # Uldaman
							leader = THIS
							owner = THIS
							troops = {
								light_infantry = { 1000 1000 }
								heavy_infantry = { 700 700 }
								archers = { 300 300 }
							}
							attrition = 0
							reinforces = no
							earmark = dwarf_awakening_troops
						}
					}
				}
			}
		}
		primary_title = {
			event_target:anvilmar_leader = {
				war = {
					target = ROOT
					casus_belli = invasion
					thirdparty_title = PREV
				}
			}
		}
		set_global_flag = dwarf_armies_spawned
		any_playable_ruler = {
			limit = {
				ai = no
			}
			narrative_event = { id = dwarfnator.4 }
		}
	}
}

#Players are told about this if they are not the DoW target.
narrative_event = {
	id = dwarfnator.4
	title = EVTTITLEDWRF.4 # Uldaman Opens
	desc = EVTDESCDWRF.4 # Rumour has it that the ruin of Uldaman, deep in the Badlands, has been unsealed... from within! Out from it march several armies of small, stout and bearded humanoids that many have taken to calling dwarves. Their destination, it seems, appears to be the mountains of Dun Morogh.
	picture = "GFX_evt_dwarves" # Placeholder
	border = "GFX_event_narrative_frame_diplomacy"
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTDWRF.4 # I never heard of these stunted warriors before.
	}
}

#In case the leader of either of the three great clans dies before the war is over, spawn a new one of that dynasty/give event target to heir.
character_event = {
	id = dwarfnator.5
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		OR = {
			character = event_target:anvilmar_leader
			character = event_target:bronzebeard_leader
			character = event_target:wildhammer_leader
			character = event_target:darkiron_leader
		}
		NOR = {
			has_global_flag = dwarf_awakening_conquest
			has_global_flag = dwarf_awakening_failure
			has_global_flag = dwarf_awakening_end
		}
	}
	
	immediate = {
		if = {
			limit = {
				character = event_target:anvilmar_leader	
			}
			if = {
				limit = {
					any_realm_character = {
						dynasty = ROOT
						is_heir = yes
					}
				}
				any_realm_character = {
					limit = {
						dynasty = ROOT
						is_heir = yes
					}
					save_event_target_as = anvilmar_leader
				}
				break = yes
			}
			create_character = {
				random_traits = yes
				trait = AK_trait_dwarf
				dynasty = 100804
				culture = bronzebeard
				religion = geomancy
				age = 50
				attributes = {
					martial = 18
					diplomacy = 12
				}
			}
			new_character = {
				save_event_target_as = anvilmar_leader
				inherit = ROOT
			}
			break = yes
		}
		if = {
			limit = {
				character = event_target:bronzebeard_leader	
			}
			if = {
				limit = {
					any_realm_character = {
						dynasty = ROOT
					}
				}
				random_realm_character = {
					limit = {
						dynasty = ROOT
					}
					save_event_target_as = bronzebeard_leader
				}
				break = yes
			}
			create_character = {
				random_traits = yes
				trait = AK_trait_dwarf
				dynasty = 100801
				culture = bronzebeard
				religion = geomancy
				age = 50
				attributes = {
					martial = 18
					diplomacy = 12
				}
			}
			new_character = {
				save_event_target_as = bronzebeard_leader
			}
			break = yes
		}
		if = {
			limit = {
				character = event_target:wildhammer_leader	
			}
			if = {
				limit = {
					any_realm_character = {
						dynasty = ROOT
					}
				}
				random_realm_character = {
					limit = {
						dynasty = ROOT
					}
					save_event_target_as = wildhammer_leader
				}
				break = yes
			}
			create_character = {
				random_traits = yes
				trait = AK_trait_dwarf
				dynasty = 100803
				culture = wildhammer
				religion = aeromancy
				age = 50
				attributes = {
					martial = 15
					learning = 13
				}
			}
			new_character = {
				save_event_target_as = wildhammer_leader
			}
			break = yes
		}
		if = {
			limit = {
				character = event_target:darkiron_leader	
			}
			if = {
				limit = {
					any_realm_character = {
						dynasty = ROOT
					}
				}
				random_realm_character = {
					limit = {
						dynasty = ROOT
					}
					save_event_target_as = darkiron_leader
				}
				break = yes
			}
			create_character = {
				random_traits = yes
				trait = AK_trait_dwarf
				dynasty = 100802
				culture = dark_iron
				religion = pyromancy
				age = 50
				attributes = {
					martial = 15
					learning = 13
				}
			}
			new_character = {
				save_event_target_as = darkiron_leader
			}
			break = yes
		}
	}
}

#Dwarves win the war. Check if anyone has lands in Dun Morogh. If so, war them all. Else, disband troops and assign bronzebeard, wildhammer and dark iron lands.
character_event = {
	id = dwarfnator.6
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			character = event_target:anvilmar_leader
		}
		ROOT = {
			character = event_target:dwarf_awakening_defender
		}
		NOR = {
			has_global_flag = dwarf_awakening_conquest
			has_global_flag = dwarf_awakening_failure
			has_global_flag = dwarf_awakening_end
		}
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_conquest
		hidden_tooltip = { character_event = { id = dwarfnator.15 } }
		c_ironforge = {
			location = {
				FROM = {
					capital = PREV
				}
			}
		}
		if = {
			limit = {
				FROM = {
					completely_controls_region = world_dun_morogh
				}
			}
			any_realm_province = {
				culture = FROM
				religion = FROM
			}
			disband_event_forces = dwarf_awakening_troops
			event_target:bronzebeard_leader = {
				c_shimmer_ridge = {
					grant_title_no_opinion = PREV
				}
				c_ironforge_heights = {
					grant_title_no_opinion = PREV
				}
				c_the_grizzled_den = {
					grant_title_no_opinion = PREV
				}
				c_ice_breeze_valley = {
					grant_title_no_opinion = PREV
				}
				c_frostmane_hold = {
					grant_title_no_opinion = PREV
				}
				d_dun_morogh_wilds = {
					grant_title_no_opinion = PREV
				}
				any_realm_province = {
					culture = THIS
					religion = THIS
				}
			}
			event_target:darkiron_leader = {
				c_anvilmar = {
					grant_title_no_opinion = PREV
				}
				c_coldridge_valley = {
					grant_title_no_opinion = PREV
				}
				c_coldridge_mountains = {
					grant_title_no_opinion = PREV
				}
				c_coldridge_coast = {
					grant_title_no_opinion = PREV
				}
				d_coldridge = {
					grant_title_no_opinion = PREV
				}
				any_realm_province = {
					culture = THIS
					religion = THIS
				}
			}
			event_target:wildhammer_leader = {
				c_kharanos = {
					grant_title_no_opinion = PREV
				}
				c_tundrid_hills = {
					grant_title_no_opinion = PREV
				}
				c_mistypine_refuge = {
					grant_title_no_opinion = PREV
				}
				c_amberstill = {
					grant_title_no_opinion = PREV
				}
				c_northbed = {
					grant_title_no_opinion = PREV
				}
				c_golbolar = {
					grant_title_no_opinion = PREV
				}
				d_kharanos = {
					grant_title_no_opinion = PREV
				}
				any_realm_province = {
					culture = THIS
					religion = THIS
				}
			}
			set_global_flag = dwarf_awakening_end
		}
		if = {
			limit = {
				FROM = {
					NOT = { completely_controls_region = world_dun_morogh }
				}
			}
			FROM = {
				any_landed_title = {
					limit = {
						region = world_dun_morogh
					}
					holder_scope = {
						reverse_war = {
							target = PREVPREV
							casus_belli = claim
							thirdparty = PREV
							infamy = 0
						}
					}
				}
			}
		}
	}
}

#Only matters if the above results in war again. Check if they own Dun Morogh. Disband troops and give bronzebeards, wildhammer and dark iron lands.
character_event = {
	id = dwarfnator.7
	hide_window = yes
	
	mean_time_to_happen = {
		days = 1
	}
	
	trigger = {
		character = event_target:anvilmar_leader
		completely_controls_region = world_dun_morogh
		NOR = {
			has_global_flag = dwarf_awakening_failure
			has_global_flag = dwarf_awakening_end
		}
	}
	
	immediate = {
		disband_event_forces = dwarf_awakening_troops
		any_realm_province = {
			culture = ROOT
			religion = ROOT
		}
		event_target:bronzebeard_leader = {
			c_shimmer_ridge = {
				grant_title_no_opinion = PREV
			}
			c_ironforge_heights = {
				grant_title_no_opinion = PREV
			}
			c_the_grizzled_den = {
				grant_title_no_opinion = PREV
			}
			c_ice_breeze_valley = {
				grant_title_no_opinion = PREV
			}
			c_frostmane_hold = {
				grant_title_no_opinion = PREV
			}
			d_dun_morogh_wilds = {
				grant_title_no_opinion = PREV
			}
			any_realm_province = {
				culture = THIS
				religion = THIS
			}
		}
		event_target:darkiron_leader = {
			c_anvilmar = {
				grant_title_no_opinion = PREV
			}
			c_coldridge_valley = {
				grant_title_no_opinion = PREV
			}
			c_coldridge_mountains = {
				grant_title_no_opinion = PREV
			}
			c_coldridge_coast = {
				grant_title_no_opinion = PREV
			}
			d_coldridge = {
				grant_title_no_opinion = PREV
			}
			any_realm_province = {
				culture = THIS
				religion = THIS
			}
		}
		event_target:wildhammer_leader = {
			c_kharanos = {
				grant_title_no_opinion = PREV
			}
			c_tundrid_hills = {
				grant_title_no_opinion = PREV
			}
			c_mistypine_refuge = {
				grant_title_no_opinion = PREV
			}
			c_amberstill = {
				grant_title_no_opinion = PREV
			}
			c_northbed = {
				grant_title_no_opinion = PREV
			}
			c_golbolar = {
				grant_title_no_opinion = PREV
			}
			d_kharanos = {
				grant_title_no_opinion = PREV
			}
			any_realm_province = {
				culture = THIS
				religion = THIS
			}
		}
		set_global_flag = dwarf_awakening_end
	}
}

#Dwarves lose the war. All Dun Morogh provinces get flags that last for quite a while and can cause dwarven hosts to appear every now and then.
character_event = {
	id = dwarfnator.8
	desc = EVTDESCDWRF.8 # Finally, the last of the bearded invaders falls. What few survivors there are have scatter and gone to hiding. Maybe they'll regroup and make another attempt at your rule later, but for now the triumph is yours.
	picture = "GFX_evt_battle_byzantine"
	border = "GFX_event_normal_frame_war"
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			character = event_target:anvilmar_leader
		}
		ROOT = {
			character = event_target:dwarf_awakening_defender
		}
		NOR = {
			has_global_flag = dwarf_awakening_conquest
			has_global_flag = dwarf_awakening_failure
			has_global_flag = dwarf_awakening_end
		}
	}
	
	option = {
		name = EVTOPTDWARF.8 # Their invasion was cut short.
		prestige = 200
		set_global_flag = dwarf_awakening_failure
		any_province = {
			limit = {
				region = world_dun_morogh
			}
			set_province_flag = dwarf_resurgence
		}
		hidden_tooltip = { character_event = { id = dwarfnator.15 } }
	}
}

#Dwarves find the gnomes.
narrative_event = {
	id = dwarfnator.9
	title = EVTTITLEDWRF.9 # Gnomeregan
	desc = EVTDESCDWRF.9 # While exploring caves around the western mountains of Dun Morogh, a startling discovery was made! Tiny humanoids, calling themselves gnomes, have been found dwelling in them. Though not physically imposing and not as good as a dwarf when it comes to stonework, they seem to have an affinity for technology unlike anything seen before. The explorers also report they felt some sort of kinship with these gnomes, who were driven into hiding by the Ice Trolls that once dominated this region. Perhaps, they propose, we should give them some land to call their own?
	picture = "GFX_evt_throne_room"
	border = "GFX_event_narrative_frame_diplomacy"
	
	min_age = 16
	only_independent = yes
	only_rulers = yes
	capable_only = yes
	prisoner = no
	
	mean_time_to_happen = {
		years = 100
	}
	
	trigger = {
		trait = AK_trait_dwarf
		completely_controls = d_gnomeregan
		num_of_count_titles = 4
		has_global_flag = dwarf_awakening_end
		NOT = { has_global_flag = gnome_awakening }
		NOT = {
			has_game_rule = {
				name = troll_wars_events
				value = off
			}
		}
		has_global_flag = trollwars_bookmark
	}
	
	immediate = {
		set_global_flag = gnome_awakening
	}
	
	option = {
		ai_chance = {
			factor = 100
		}
		name = EVTOPTDWRF.9a # Yes. Let them have the region.
		set_global_flag = dwarf_awakening_gnomes_settled
		create_character = {
			random_traits = yes
			dynasty = random
			trait = gnome
			culture = gnomish
			religion = arcane
			age = 40
		}
		new_character = {
			c_gnomeregan = {
				grant_title = PREV
				culture = gnomish
				religion = arcane
			}
			c_brewnall = {
				grant_title = PREV
				culture = gnomish
				religion = arcane
			}
			c_iceflow_lake = {
				grant_title = PREV
				culture = gnomish
				religion = arcane
			}
			d_gnomeregan = {
				grant_title = PREV
			}
			k_gnomeregan = {
				grant_title = PREV
			}
			set_defacto_liege = THIS
			any_realm_province = {
				culture = PREV
				religion = PREV
			}
			add_friend = ROOT
			add_alliance = { who = ROOT years = 5000 }
		}
	}
	
	option = {
		ai_chance = {
			factor = 1
			modifier = {
				factor = 50
				has_game_rule = {
					name = troll_wars_events
					value = alternate
				}
			}
		}
		name = EVTOPTDWRF.9b # Absolutely not!
		c_gnomeregan = {
			location = {
				culture = gnomish
				set_province_flag = gnome_resurgence
			}
		}
		c_brewnall = {
			location = {
				culture = gnomish
				set_province_flag = gnome_resurgence
			}
		}
		c_iceflow_lake = {
			location = {
				culture = gnomish
				set_province_flag = gnome_resurgence
			}
		}
	}
}

#Dwarf resurgence.
province_event = {
	id = dwarfnator.10
	hide_window = yes
	
	mean_time_to_happen = {
		years = 20
		modifier = {
			factor = 0.5
			owner = {
				war = yes
			}
		}
	}
	
	trigger = {
		has_global_flag = dwarf_awakening_failure
		NOT = { has_global_flag = dwarf_awakening_resurgence }
		has_province_flag = dwarf_resurgence
		location = world_EK_Central
	}
	
	immediate = {
		random_list = {
			10 = {
				create_character = {
					random_traits = yes
					trait = AK_trait_dwarf
					culture = bronzebeard
					religion = geomancy
					dynasty = 100801
					employer = THIS
					age = 50
				}
				new_character = {
					create_title = {
						tier = DUKE
						landless = yes
						temporary = yes
						rebel = yes
						name = DWARF_HOST
						culture = bronzebeard
						holder = THIS
					}
					spawn_unit = {
						province = ROOT
						home = ROOT
						owner = THIS
						leader = THIS
						scaled_by_biggest_garrison = 2
						troops = {
							light_infantry = { 10 10 }
							heavy_infantry = { 5 5 }
							archers = { 3 3 }
						}
						attrition = 1.0
					}
					ROOT = {
						holder_scope = {
							reverse_war = {
								target = PREVPREV
								casus_belli = invasion
								thirdparty = PREV
								infamy = 0
							}
						}
					}
				}
			}
			10 = {
				create_character = {
					random_traits = yes
					trait = AK_trait_dwarf
					culture = dark_iron
					religion = pyromancy
					dynasty = 100802
					employer = THIS
					age = 50
				}
				new_character = {
					create_title = {
						tier = DUKE
						landless = yes
						temporary = yes
						rebel = yes
						name = DWARF_HOST
						culture = dark_iron
						holder = THIS
					}
					spawn_unit = {
						province = ROOT
						home = ROOT
						owner = THIS
						leader = THIS
						scaled_by_biggest_garrison = 2
						troops = {
							light_infantry = { 10 10 }
							heavy_infantry = { 5 5 }
							archers = { 3 3 }
						}
						attrition = 1.0
					}
					ROOT = {
						holder_scope = {
							reverse_war = {
								target = PREVPREV
								casus_belli = invasion
								thirdparty = PREV
								infamy = 0
							}
						}
					}
				}
			}
			10 = {
				create_character = {
					random_traits = yes
					trait = AK_trait_dwarf
					culture = wildhammer
					religion = aeromancy
					dynasty = 100803
					employer = THIS
					age = 50
				}
				new_character = {
					create_title = {
						tier = DUKE
						landless = yes
						temporary = yes
						rebel = yes
						name = DWARF_HOST
						culture = wildhammer
						holder = THIS
					}
					spawn_unit = {
						province = ROOT
						home = ROOT
						owner = THIS
						leader = THIS
						scaled_by_biggest_garrison = 2
						troops = {
							light_infantry = { 10 10 }
							heavy_infantry = { 5 5 }
							archers = { 3 3 }
						}
						attrition = 1.0
					}
					ROOT = {
						holder_scope = {
							reverse_war = {
								target = PREVPREV
								casus_belli = invasion
								thirdparty = PREV
								infamy = 0
							}
						}
					}
				}
			}
		}
	}
}

#End to dwarf resurgence.
character_event = {
	id = dwarfnator.11
	hide_window = yes
	
	mean_time_to_happen = {
		years = 400 # Because it might happen sooner.
	}
	
	trigger = {
		has_global_flag = dwarf_awakening_failure
		NOT = { has_global_flag = dwarf_awakening_resurgence }
	}
	
	immediate = {
		any_province = {
			limit = {
				region = world_dun_morogh
			}
			clr_province_flag = dwarf_resurgence
		}
	}
}

#If a dwarf manages to grab themselves a landed duke-tier title or higher.
character_event = {
	id = dwarfnator.12
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = dwarf_awakening_failure
		NOT = { has_global_flag = dwarf_awakening_resurgence }
		ROOT = {
			trait = AK_trait_dwarf
			is_landed = yes
			higher_tier_than = COUNT
		}
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_resurgence
	}
}

#Infinite Intervention
character_event = {
	id = dwarfnator.13
	desc = EVTDESCDWRF.13 # Strange grey dragons have come to your aid against the bearded warriors who assault your lands. They do not tell you why, or really anything at all for that matter, but you are not exactly in a mood to ask either, lest they remove their support.
	picture = "EVT_gfx_infinite_dragon"
	border = "GFX_event_normal_frame_war"
	
	mean_time_to_happen = {
		years = 1000 # Need to test for how unlikely it is.
		modifier = {
			factor = 0.5
			has_game_rule = {
				name = troll_wars_events
				value = alternate
			}
		}
		modifier = {
			factor = 0.1
			has_game_rule = {
				name = infinite_dragons
				value = more
			}
		}
	}
	
	trigger = {
		NOR = {
			has_global_flag = dwarf_awakening_conquest
			has_global_flag = dwarf_awakening_failure
			has_global_flag = dwarf_awakening_infinites
		}
		has_global_flag = dwarf_awakening_start
		OR = {
			AND = {
				has_landed_title = c_ironforge
				independent = yes
			}
			any_realm_character = {
				has_landed_title = c_ironforge
			}
		}
		any_war = {
			using_cb = invasion
			war_score = -100
			NOT = { war_score = -49 }
		}
		NOT = {
			has_game_rule = {
				name = infinite_dragons
				value = off
			}
		}
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_infinites
		create_character = {
			age = 360
			religion = cult_of_the_infinite
			culture = infinite_dragonflight
			dynasty = 101010
			attributes = {
				martial = 21
			}
			random_traits = yes
			trait = dragon_infinite
			trait = dragon_dragon
			flag = race_assigned
		}
		new_character = {
			save_event_target_as = dwarf_awakening_infinite_leader
			create_title = {
				tier = DUKE
				temporary = yes
				culture = infinite_dragonflight
				name = INFINITE_INTERVENTION
				holder = THIS
			}
			ROOT = {
				location = {
					save_event_target_as = infinite_spawn
				}
				spawn_unit = {
					province = event_target:infinite_spawn
					owner = PREV
					leader = PREV
					disband_on_peace = yes
					troops = {
						dragon_troop = { 20 20 }
						heavy_infantry = { 900 900 }
						light_cavalry = { 550 550 }
					}
					attrition = 0
					maintenance = no
					reinforces = yes
				}
			}
			add_alliance = { 
				who = ROOT	
				years = 100 
			}
		}
	}
	
	option = {
		name = EVTOPTTROLLWAR.45 # Unexpected. But not unwelcome.
		hidden_tooltip = {
			any_playable_ruler = {
				limit = {
					ai = no
					top_liege = { character = ROOT }
				}
				character_event = { id = dwarfnator.14 }
			}
		}
	}
}

#Player vassals of the defender are informed.
character_event = {
	id = dwarfnator.14
	desc = EVTDESCDWRF.14 # Seemingly from out of nowhere, grey dragons have been seen aiding our forces in various battles against the bearded invaders. Though they refuse to communicate, few are willing to question this unlikely ally.
	picture = "EVT_gfx_infinite_dragon"
	border = "GFX_event_normal_frame_war"
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTTROLLWAR.45 # Unexpected. But not unwelcome.
	}
}

#Remove Infinites upon end of war.
character_event = {
	id = dwarfnator.15
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		event_target:dwarf_awakening_infinite_leader = {
			death = { death_reason = death_murder_unknown killer = ROOT }
		}
	}
}

#Gnome resurgence.
province_event = {
	id = dwarfnator.16
	hide_window = yes
	
	mean_time_to_happen = {
		years = 20
		modifier = {
			factor = 0.5
			owner = {
				war = yes
			}
		}
	}
	
	trigger = {
		NOT = { has_global_flag = dwarf_awakening_failure }
		NOT = { has_global_flag = dwarf_awakening_gnome_resurgence }
		has_province_flag = gnome_resurgence
		location = world_EK_Central
	}
	
	immediate = {
		create_character = {
			random_traits = yes
			trait = gnome
			culture = gnomish
			religion = arcane
			dynasty = random
			employer = THIS
			age = 40
		}
		new_character = {
			create_title = {
				tier = DUKE
				landless = yes
				temporary = yes
				rebel = yes
				name = GNOME_HOST
				culture = gnomish
				holder = THIS
			}
			spawn_unit = {
				province = ROOT
				home = ROOT
				owner = THIS
				leader = THIS
				scaled_by_biggest_garrison = 2
				troops = {
					light_infantry = { 10 10 }
					heavy_infantry = { 1 1 }
					archers = { 7 7 }
				}
				attrition = 1.0
			}
			ROOT = {
				holder_scope = {
					reverse_war = {
						target = PREVPREV
						casus_belli = invasion
						thirdparty = PREV
						infamy = 0
					}
				}
			}
		}
	}
}

#End to gnome resurgence.
character_event = {
	id = dwarfnator.17
	hide_window = yes
	
	mean_time_to_happen = {
		years = 400 # Because it might happen sooner.
	}
	
	trigger = {
		NOT = { has_global_flag = dwarf_awakening_failure }
		NOT = { has_global_flag = dwarf_awakening_gnome_resurgence }
	}
	
	immediate = {
		any_province = {
			limit = {
				region = world_dun_morogh
			}
			clr_province_flag = gnome_resurgence
		}
	}
}

#If a gnome manages to grab themselves a landed duke-tier title or higher.
character_event = {
	id = dwarfnator.18
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		NOT = { has_global_flag = dwarf_awakening_failure }
		NOT = { has_global_flag = dwarf_awakening_gnome_resurgence }
		ROOT = {
			trait = gnome
			is_landed = yes
			higher_tier_than = COUNT
		}
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_gnome_resurgence
	}
}

#Last gnome king.
character_event = {
	id = dwarfnator.19
	desc = EVTDESCDWRF.19 # As of late, a radical new idea has been making its way across Gnomeregan: the end of the monarchy, and instead having the realm be ruled by an elected technical expert. A technocracy. This idea has gained traction through various segments of the population and is quickly becoming a movement.
	picture = "GFX_evt_throne_room"
	border = "GFX_event_normal_frame_diplomacy"
	
	mean_time_to_happen = {
		years = 500
		modifier = {
			factor = 0.02
			year = 9400
		}
		modifier = {
			factor = 1.5
			has_game_rule = {
				name = troll_wars_events
				value = alternate
			}
		}
	}
	
	trigger = {
		OR = {
			has_global_flag = dwarf_awakening_gnome_ressurgence
			has_global_flag = dwarf_awakening_gnomes_settled
		}
		NOT = { has_global_flag = dwarf_awakening_last_gnome_king_start }
		OR = {
			year = 9000
			has_game_rule = {
				name = troll_wars_events
				value = alternate
			}
		}
		OR = {
			AND = {
				has_landed_title = c_gnomeregan
				NOT = {	is_title_active = d_gnomeregan }
				NOT = { is_title_active = k_gnomeregan }
				NOT = {
					d_gnomeregan = {
						holder_scope = {
							trait = gnome
						}
					}
				}
				NOT = {
					k_gnomeregan = {
						holder_scope = {
							trait = gnome
						}
					}
				}
			}
			AND = {
				has_landed_title = d_gnomeregan
				NOT = { is_title_active = k_gnomeregan }
				NOT = {
					k_gnomeregan = {
						holder_scope = {
							trait = gnome
						}
					}
				}
			}
			has_landed_title = k_gnomeregan
		}
		trait = gnome
		government = feudal_government
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_last_gnome_king_start # This is stupid
	}
	
	option = {
		ai_chance = {
			factor = 100
		}
		name = EVTOPTDWRF.19a # A brilliant idea!
		set_character_flag = last_gnome_king
		any_playable_ruler = {
			limit = {
				trait = gnome
			}
			narrative_event = { id = dwarfnator.20 }
		}
		set_global_flag = dwarf_awakening_last_gnome_king_end
		set_government_type = technocracy_government
		any_realm_title = {
			limit = {
				higher_real_tier_than = COUNT
				holder_scope = {
					trait = gnome
				}
			}
			holder_scope = {
				set_government_type = technocracy_government
			}
			add_law = succ_feudal_elective
			add_law = cognatic_succession
		}
	}
	
	option = {
		ai_chance = {
			factor = 1
			modifier = {
				factor = 50
				has_game_rule = {
					name = troll_wars_events
					value = alternate
				}
			}
		}
		name = EVTOPTDWRF.19b # No scientist can substitute royalty!
		create_character = {
			random_traits = yes
			trait = gnome
			culture = gnomish
			religion = arcane
			dynasty = random
			employer = THIS
			age = 40
		}
		new_character = {
			set_character_flag = technocrat_rebel
			set_government_type = technocracy_government
			create_title = {
				tier = DUKE
				landless = yes
				temporary = yes
				rebel = yes
				name = GNOME_HOST
				culture = gnomish
				holder = THIS
			}
			location = {
				PREV = {
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						leader = THIS
						troops = {
							light_infantry = { 20 20 }
							heavy_infantry = { 1 1 }
							archers = { 2 2 }
							constructs = { 2 2 }
						}
						match_character = ROOT
						match_mult = 2
						attrition = 1.0
					}
				}
			}
			ROOT = {
				reverse_war = {
					target = PREV
					casus_belli = overthrow_ruler
					infamy = 0
				}
			}
		}
		any_playable_ruler = {
			limit = {
				ai = no
				trait = gnome
				NOT = { character = ROOT }
			}
			narrative_event = { id = dwarfnator.21 }
		}
	}
}

#Technocracy adopted.
narrative_event = {
	id = dwarfnator.20
	title = EVTTITLEDWRF.20 # The Last Gnome Monarch
	desc = {
		trigger = {
			has_character_flag = last_gnome_king
		}
		text = EVTDESCDWRF.20a # You agree with the technocrats: it's time for a change in how gnomes govern themselves. After all, if you can't trust the most learned and brilliant among you to be a good ruler, then who can you trust to do it?
	}
	desc = {
		trigger = {
			NOT = { has_character_flag = last_gnome_king }
		}
		text = EVTDESCDWRF.20b # As of late, a new ideology has arisen in the gnomish realm of Gnomeregan: the idea that a ruler should be not some noble who inherited their title, but a scholar or technician elected by their peers. It seems that [From.GetTitledName] agrees with this, and is working on transitioning the government of the gnomes to its newest form.
	}
	picture = "GFX_evt_throne_room"
	border = "GFX_event_narrative_frame_diplomacy"
	
	is_triggered_only = yes
	
	option = {
		name = OK
		if = {
			limit = {
				trait = gnome
			}
			set_government_type = technocracy_government
		}
	}
}

#Technocracy rejected, rebellion!
narrative_event = {
	id = dwarfnator.21
	title = EVTTITLEDWRF.21 # The Technocrats
	desc = EVTDESCDWRF.21 # As of late, a new ideology has arisen in the gnomish realm of Gnomeregan: the idea that a ruler should be not some noble who inherited their title, but a scholar or technician elected by their peers. The gnomish monarch, however, is less than pleased and denounced such ideas. Frustrated, the technocrats of Gnomeregan have taken up arms and seek to depoise their [From.GetTitle].
	picture = GFX_evt_peasants
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = OK
	}
}

#Technocrats win rebellion.
character_event = {
	id = dwarfnator.22
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_character_flag = technocrat_rebel
		}
		has_character_flag = last_gnome_king
		has_global_flag = dwarf_awakening_last_gnome_king_start
		NOT = { has_global_flag = dwarf_awakening_last_gnome_king_end }
		any_war = { using_cb = overthrow_ruler }
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_last_gnome_king_end
		any_playable_ruler = {
			limit = {
				OR = {
					trait = gnome
					ai = no
				}
			}
			narrative_event = { id = dwarfnator.23 }
		}
		any_realm_title = {
			limit = {
				higher_real_tier_than = COUNT
				holder_scope = {
					trait = gnome
				}
			}
			holder_scope = {
				set_government_type = technocracy_government
			}
			add_law = succ_feudal_elective
			add_law = cognatic_succession
		}
	}
}

#Players informed.
narrative_event = {
	id = dwarfnator.23
	title = EVTTITLEDWRF.20 # The Last Gnome Monarch
	desc = EVTDESCDWRF.23 # [From.GetTitledName], last [From.GetTitle] of Gnomeregan has been defeated by the technocratic rebellion, and a new form of government is now used by the gnomes.
	picture = "GFX_evt_throne_room"
	border = "GFX_event_narrative_frame_diplomacy"
	
	is_triggered_only = yes
	
	option = {
		name = OK
		if = {
			limit = {
				trait = gnome
			}
			set_government_type = technocracy_government
		}
	}
}

#Technocrats lose rebellion.
character_event = {
	id = dwarfnator.24
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_character_flag = technocrat_rebel
		}
		has_character_flag = last_gnome_king
		has_global_flag = dwarf_awakening_last_gnome_king_start
		NOT = { has_global_flag = dwarf_awakening_last_gnome_king_end }
		any_war = { using_cb = overthrow_ruler }
	}
	
	immediate = {
		set_global_flag = dwarf_awakening_last_gnome_king_end
		any_playable_ruler = {
			limit = {
				ai = no
				NOT = { character = ROOT }
			}
			narrative_event = { id = dwarfnator.25 }
		}
	}
}

#Players informed.
narrative_event = {
	id = dwarfnator.25
	title = EVTTITLEDWRF.25 # Enlightened Monarchy
	desc = EVTDESCDWRF.25 # The technocratic rebellion that rose up against [From.GetTitledName] in Gnomeregan has been put down. As the last pockets of resistance are rooted out, it appears that monarchy is the truly enlightened form of government.
	picture = GFX_evt_peasants
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = OK
	}
}